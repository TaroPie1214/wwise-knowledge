# 集成详情——音乐回调

|  |
| --- |
| Wwise SDK 2025.1.4 - Windows |

集成详情——音乐回调

# 简介

在为游戏创建互动音乐时，您需要音乐的节拍信息。您可以使用音乐通知从声音引擎索取这些信息。节拍由当前正在播放的主要音乐段落（music segment）决定。由于音乐段落可能具有不同的拍号，因此节拍将随着当前正在播放的音乐而变化。当没有音乐在播放时，就不会有通知。

有两种音乐回调类型：

- 音乐通知（Music Notifications）：告诉被调用方当前音乐的播放属性。
- 音乐播放列表选择（Muisc Playlist Selection）：被调用方可以强制选择音乐播放列表中的下一项。

# 如何使用音乐通知

如果您想收到有关音乐的标记（marker）通知，在设计应用程序时需要特别注意以下几点：

- 在要发送的播放事件中包含有音乐且您需要跟随音乐的节拍时，您可以添加以下若干个标志：

[AK\_MusicSyncBeat](_ak_callback_types_8h_a948c083ff18dc4c8dfe1d32cb0eb6732.html#a948c083ff18dc4c8dfe1d32cb0eb6732a62d1f7986a64a7e9980ff82bd7ae9ba4) = 0x0100, // 在音乐节拍点上启用通知。

[AK\_MusicSyncBar](_ak_callback_types_8h_a948c083ff18dc4c8dfe1d32cb0eb6732.html#a948c083ff18dc4c8dfe1d32cb0eb6732ad7d4cc2283a63337542d49c70e55d9ca) = 0x0200, // 音乐小节时间点上启用通知。

[AK\_MusicSyncEntry](_ak_callback_types_8h_a948c083ff18dc4c8dfe1d32cb0eb6732.html#a948c083ff18dc4c8dfe1d32cb0eb6732ab29d1a78a0f92336b1c155548bc88d72) = 0x0400, // 在音乐入口处启用通知。

[AK\_MusicSyncExit](_ak_callback_types_8h_a948c083ff18dc4c8dfe1d32cb0eb6732.html#a948c083ff18dc4c8dfe1d32cb0eb6732aa92ff2f82ed7a651772e1f3f1d31c76e) = 0x0800, // 在音乐出口处启用通知。

[AK\_MusicSyncGrid](_ak_callback_types_8h_a948c083ff18dc4c8dfe1d32cb0eb6732.html#a948c083ff18dc4c8dfe1d32cb0eb6732a474f5b9582617f8a4f744e7d47dfa155) = 0x1000, // 在音乐网格上启用通知。

[AK\_MusicSyncUserCue](_ak_callback_types_8h_a948c083ff18dc4c8dfe1d32cb0eb6732.html#a948c083ff18dc4c8dfe1d32cb0eb6732ac827761a64b0d02303ea7eaa98240392) = 0x2000, // 在音乐用户提示点上启用通知。

[AK\_MusicSyncPoint](_ak_callback_types_8h_a948c083ff18dc4c8dfe1d32cb0eb6732.html#a948c083ff18dc4c8dfe1d32cb0eb6732afde5b3e18578530b70f6e1241a552253) = 0x4000, // 在音乐同步点上启用通知。

[AK\_MusicSyncAll](_ak_callback_types_8h_a948c083ff18dc4c8dfe1d32cb0eb6732.html#a948c083ff18dc4c8dfe1d32cb0eb6732af2fd49e6c33cc7831091387fec8a6fad) = 0xff00, // 如果您想收到有关 AK\_MusicSync 注册的所有通知，则使用此标志。

如果您还想在事件结束时收到通知，则应使用 `AK_EndOfEvent` | `AK_MusicSyncBeat，因为这些标志按位做异或运算。`

[AkPlayingID](_ak_typedefs_8h_a9270609771369ea575443fe080bbe9c3.html#a9270609771369ea575443fe080bbe9c3) [AK::SoundEngine::PostEvent](namespace_a_k_1_1_sound_engine_a41e9ef8d42951871fe4a8ae58a29a68e.html#a41e9ef8d42951871fe4a8ae58a29a68e)(

[AkUniqueID](_ak_typedefs_8h_a8341fa4d01d2fa852c3cc410401b04dc.html#a8341fa4d01d2fa852c3cc410401b04dc) in\_eventID, // Unique ID of the event

[AkGameObjectID](_ak_typedefs_8h_a352a1eb6955fa208062e40a9ccdd2560.html#a352a1eb6955fa208062e40a9ccdd2560) in\_gameObjectID, // Associated game object ID

[AkUInt32](_ak_numeral_types_8h_a39c6c5d577901802ca77775760b704ce.html#a39c6c5d577901802ca77775760b704ce) in\_uFlags = 0, // Bitmask: see AkCallbackType

[AkCallbackFunc](_ak_callback_types_8h_af644072775b1cdd813e2d32792a22005.html#af644072775b1cdd813e2d32792a22005) in\_pfnCallback = NULL, // Callback function

void \* in\_pCookie = NULL // Callback cookie that will be sent to the callback function

// along with additional information

);

- 您的回调函数必须采用以下格式：

static void MusicCallback(

[AkCallbackType](_ak_callback_types_8h_a948c083ff18dc4c8dfe1d32cb0eb6732.html#a948c083ff18dc4c8dfe1d32cb0eb6732) in\_eType, // 回调原因的类型，在本例中，类型可以是 AK\_MusicSyncBeat

[AkCallbackInfo](struct_ak_callback_info.html)\* in\_pCallbackInfo // 指向回调信息结构的指针，在本例中

// AkMusicSyncCallbackInfo\*。

）

- 当您调用回调函数时，您首先需要检查传入的是哪种通知。例如，如果您只想处理 `AK_MusicSyncBar` 通知，则当收到任何其它事件类型时，您应该直接返回。
- 根据通知的类型，您可以将`in_pCallbackInfo` 类型转换（typecast）为相应的信息结构类型。对于音乐通知，它是 AkMusicSyncCallbackInfo。

/// 对应于 Ak\_MusicSync 的回调信息结构

struct [AkMusicSyncCallbackInfo](struct_ak_music_sync_callback_info.html) : public [AkCallbackInfo](struct_ak_callback_info.html)

{

[AkPlayingID](_ak_typedefs_8h_a9270609771369ea575443fe080bbe9c3.html#a9270609771369ea575443fe080bbe9c3) playingID; ///< 正在播放的事件 ID，由 PostEvent() 返回

[AkCallbackType](_ak_callback_types_8h_a948c083ff18dc4c8dfe1d32cb0eb6732.html#a948c083ff18dc4c8dfe1d32cb0eb6732) [musicSyncType](struct_ak_music_sync_callback_info_ae414e6cf2d393635bf302a2fbc51d8cb.html#ae414e6cf2d393635bf302a2fbc51d8cb); ///< 可以是 AK\_MusicSyncEntry、AK\_MusicSyncBeat、AK\_MusicSyncBar、AK\_MusicSyncExit、AK\_MusicSyncGrid、AK\_MusicSyncPoint 或 AK\_MusicSyncUserCue。

[AkReal32](_ak_numeral_types_8h_afc38459f26e2b23defe588026e886a98.html#afc38459f26e2b23defe588026e886a98) fBeatDuration; ///< 节拍时长，单位：秒。

[AkReal32](_ak_numeral_types_8h_afc38459f26e2b23defe588026e886a98.html#afc38459f26e2b23defe588026e886a98) fBarDuration; ///< 小节时长，单位：秒。

[AkReal32](_ak_numeral_types_8h_afc38459f26e2b23defe588026e886a98.html#afc38459f26e2b23defe588026e886a98) fGridDuration; ///< 网格时长，单位：秒。

[AkReal32](_ak_numeral_types_8h_afc38459f26e2b23defe588026e886a98.html#afc38459f26e2b23defe588026e886a98) fGridOffset; ///< 网格偏置，单位：秒。

};

注解
:   当请求多个音乐通知时，将发送这些额外通知。这意味着，如果您在拍号 4/4 下注册 `AK_MusicSyncBeat` 和 `AK_MusicSyncBar，则每小节中您将收到` 4 次节拍通知和小节本身的一次通知。拍号“0”对节拍和小节也很重要，而且在大多数情况下对 `AK_MusicSyncEntry` 也同样重要。这意味着，如果您注册小节、节拍和入口，则当音乐启动时，您将连续收到三个回调。
:   速度可通过以下公式计算：速度（以 BPM 为单位）= 60.0 / fBeatDuration
:   拍号的上限值可通过以下公式计算：上限值 = fBarDuration / fBeatDuration。 这告诉您每个小节有多少拍。
:   只有到达当前音乐段落的末尾时，才会发送通知 `AK_MusicSyncExit` 。如果在完成当前音乐前，音乐切换到另一段落，则不会发送 `AK_MusicSyncExit` 通知。

参见
:   [快速入门示例集成——事件](quickstart_sample_integration_events.html)

# 如何使用音乐播放列表回调

上述回调函数还可用于手动管理音乐播放列表中的下一项选择。这可以通过添加以下标志来实现。

[AK\_MusicPlaylistSelect](_ak_callback_types_8h_a948c083ff18dc4c8dfe1d32cb0eb6732.html#a948c083ff18dc4c8dfe1d32cb0eb6732aec46a37d9cfdef25777042feaf56e265) = 0x0040 // 当音乐播放列表容器必须选择要播放的下一项时，将触发回调。

一旦收到此类事件，回调函数必须把参数 `in_pCallbackInfo` 强制转换成类型 AkMusicPlaylistCallbackInfo。

/// 对应于 Ak\_MusicPlaylistSelect 的回调信息结构

struct [AkMusicPlaylistCallbackInfo](struct_ak_music_playlist_callback_info.html) : public [AkEventCallbackInfo](struct_ak_event_callback_info.html)

{

[AkPlayingID](_ak_typedefs_8h_a9270609771369ea575443fe080bbe9c3.html#a9270609771369ea575443fe080bbe9c3) [playlistID](struct_ak_music_playlist_callback_info_a4015338108567c652d091d526a694775.html#a4015338108567c652d091d526a694775); ///< 音乐播放列表容器中的活跃节点的 ID

[AkUInt32](_ak_numeral_types_8h_a39c6c5d577901802ca77775760b704ce.html#a39c6c5d577901802ca77775760b704ce) [uNumPlaylistItems](struct_ak_music_playlist_callback_info_adef75376a27daf80e948ecc7d2c20eb8.html#adef75376a27daf80e948ecc7d2c20eb8); ///< 播放列表节点中的项目数（可以是段落或其它播放列表）

[AkUInt32](_ak_numeral_types_8h_a39c6c5d577901802ca77775760b704ce.html#a39c6c5d577901802ca77775760b704ce) [uPlaylistSelection](struct_ak_music_playlist_callback_info_a21553360a102b37444487bfe6b7f8f90.html#a21553360a102b37444487bfe6b7f8f90); ///< 选择：由声音引擎设置，由回调函数更改（如果不在值域 0 <= uPlaylistSelection < uNumPlaylistItems 范围内，则忽略）

[AkUInt32](_ak_numeral_types_8h_a39c6c5d577901802ca77775760b704ce.html#a39c6c5d577901802ca77775760b704ce) [uPlaylistItemDone](struct_ak_music_playlist_callback_info_a2d245ddc4450970aa843904cf5faf474.html#a2d245ddc4450970aa843904cf5faf474); ///< 播放列表节点已完成：由声音引擎设置，回调函数更改（如果设置为除 0 以外的任何值，则执行当前播放列表条目，并忽略 uPlaylistSelection）

};

活跃的播放列表节点通过成员 `playlistID` 标示。在调用回调函数前，声音引擎选择播放列表节点中的下一项。此选择包含在成员 `uPlaylistSelection` 和 `uPlaylistItemDone` 中。如果 `uPlaylistItemDone` 设为 0，则 `uPlaylistSelection` 决定播放列表节点中要播放的下一项。如果 `uPlaylistItemDone` 未设为 0，则当前播放列表节点跳到末尾（然后父节点将变成活动节点）。成员 `uPlaylistSelection` 和 `uPlaylistItemDone` 可通过回调函数来更改。

# 通知延迟

目前当缓冲区向下传递到硬件时发送通知。这意味着在发送通知与实际播放它之间存在一个恒定的延时。这样在真正播放与标记关联的声音之前，应用程序有足够的时间来收集并处理标记中的信息。

注意这个延时取决于平台。

# 回调线程

回调从声音引擎的主线程执行。这意味着您的应用程序应从通知中收集它所需的全部信息，并立即返回。如果需要执行任何处理，则应从通知中复制相关信息后，在单独的线程中执行。

如果应用程序占用线程太久，声音引擎可能掉入 underrun（欠载运行）状态，导致输出停止播放。

参见
:   [集成详情——事件](soundengine_events.html)

[AkCallbackFunc](_ak_callback_types_8h_af644072775b1cdd813e2d32792a22005.html#af644072775b1cdd813e2d32792a22005)

AkEventCallbackFunc AkCallbackFunc

**Definition:** [AkCallbackTypes.h:350](_ak_callback_types_8h_source.html#l00350)

[AkMusicSyncCallbackInfo::musicSyncType](struct_ak_music_sync_callback_info_ae414e6cf2d393635bf302a2fbc51d8cb.html#ae414e6cf2d393635bf302a2fbc51d8cb)

enum AkCallbackType musicSyncType

Would be either AK\_MusicSyncEntry, AK\_MusicSyncBeat, AK\_MusicSyncBar, AK\_MusicSyncExit,...

**Definition:** [AkCallbackTypes.h:266](_ak_callback_types_8h_source.html#l00253)

[AkEventCallbackInfo](struct_ak_event_callback_info.html)

**Definition:** [AkCallbackTypes.h:159](_ak_callback_types_8h_source.html#l00158)

[AkMusicPlaylistCallbackInfo::uPlaylistSelection](struct_ak_music_playlist_callback_info_a21553360a102b37444487bfe6b7f8f90.html#a21553360a102b37444487bfe6b7f8f90)

AkUInt32 uPlaylistSelection

Selection: set by sound engine, modified by callback function (if not in range 0 <= uPlaylistSelectio...

**Definition:** [AkCallbackTypes.h:252](_ak_callback_types_8h_source.html#l00252)

[AK\_MusicSyncEntry](_ak_callback_types_8h_a948c083ff18dc4c8dfe1d32cb0eb6732.html#a948c083ff18dc4c8dfe1d32cb0eb6732ab29d1a78a0f92336b1c155548bc88d72)

@ AK\_MusicSyncEntry

Enable notifications on Music Entry Cue. Callback info can be cast to AkMusicSyncCallbackInfo.

**Definition:** [AkCallbackTypes.h:76](_ak_callback_types_8h_source.html#l00076)

[AkGameObjectID](_ak_typedefs_8h_a352a1eb6955fa208062e40a9ccdd2560.html#a352a1eb6955fa208062e40a9ccdd2560)

AkUInt64 AkGameObjectID

Game object ID

**Definition:** [AkTypedefs.h:39](_ak_typedefs_8h_source.html#l00039)

[AkCallbackInfo](struct_ak_callback_info.html)

**Definition:** [AkCallbackTypes.h:273](_ak_callback_types_8h_source.html#l00272)

[AK\_MusicSyncBar](_ak_callback_types_8h_a948c083ff18dc4c8dfe1d32cb0eb6732.html#a948c083ff18dc4c8dfe1d32cb0eb6732ad7d4cc2283a63337542d49c70e55d9ca)

@ AK\_MusicSyncBar

Enable notifications on Music Bar. Callback info can be cast to AkMusicSyncCallbackInfo.

**Definition:** [AkCallbackTypes.h:75](_ak_callback_types_8h_source.html#l00075)

[AK\_MusicSyncUserCue](_ak_callback_types_8h_a948c083ff18dc4c8dfe1d32cb0eb6732.html#a948c083ff18dc4c8dfe1d32cb0eb6732ac827761a64b0d02303ea7eaa98240392)

@ AK\_MusicSyncUserCue

Enable notifications on Music Custom Cue. Callback info can be cast to AkMusicSyncCallbackInfo.

**Definition:** [AkCallbackTypes.h:79](_ak_callback_types_8h_source.html#l00079)

[AK\_MusicSyncBeat](_ak_callback_types_8h_a948c083ff18dc4c8dfe1d32cb0eb6732.html#a948c083ff18dc4c8dfe1d32cb0eb6732a62d1f7986a64a7e9980ff82bd7ae9ba4)

@ AK\_MusicSyncBeat

Enable notifications on Music Beat. Callback info can be cast to AkMusicSyncCallbackInfo.

**Definition:** [AkCallbackTypes.h:74](_ak_callback_types_8h_source.html#l00074)

[AkUniqueID](_ak_typedefs_8h_a8341fa4d01d2fa852c3cc410401b04dc.html#a8341fa4d01d2fa852c3cc410401b04dc)

AkUInt32 AkUniqueID

Unique 32-bit ID

**Definition:** [AkTypedefs.h:31](_ak_typedefs_8h_source.html#l00031)

[AK\_MusicSyncPoint](_ak_callback_types_8h_a948c083ff18dc4c8dfe1d32cb0eb6732.html#a948c083ff18dc4c8dfe1d32cb0eb6732afde5b3e18578530b70f6e1241a552253)

@ AK\_MusicSyncPoint

Enable notifications on Music switch transition synchronization point. Callback info can be cast to A...

**Definition:** [AkCallbackTypes.h:80](_ak_callback_types_8h_source.html#l00080)

[AkReal32](_ak_numeral_types_8h_afc38459f26e2b23defe588026e886a98.html#afc38459f26e2b23defe588026e886a98)

float AkReal32

32-bit floating point

**Definition:** [AkNumeralTypes.h:43](_ak_numeral_types_8h_source.html#l00043)

[AK\_MusicSyncAll](_ak_callback_types_8h_a948c083ff18dc4c8dfe1d32cb0eb6732.html#a948c083ff18dc4c8dfe1d32cb0eb6732af2fd49e6c33cc7831091387fec8a6fad)

@ AK\_MusicSyncAll

Use this flag if you want to receive all notifications concerning AK\_MusicSync registration.

**Definition:** [AkCallbackTypes.h:88](_ak_callback_types_8h_source.html#l00088)

[AkMusicPlaylistCallbackInfo::uPlaylistItemDone](struct_ak_music_playlist_callback_info_a2d245ddc4450970aa843904cf5faf474.html#a2d245ddc4450970aa843904cf5faf474)

AkUInt32 uPlaylistItemDone

Playlist node done: set by sound engine, modified by callback function (if set to anything but 0 then...

**Definition:** [AkCallbackTypes.h:253](_ak_callback_types_8h_source.html#l00253)

[AK\_MusicSyncExit](_ak_callback_types_8h_a948c083ff18dc4c8dfe1d32cb0eb6732.html#a948c083ff18dc4c8dfe1d32cb0eb6732aa92ff2f82ed7a651772e1f3f1d31c76e)

@ AK\_MusicSyncExit

Enable notifications on Music Exit Cue. Callback info can be cast to AkMusicSyncCallbackInfo.

**Definition:** [AkCallbackTypes.h:77](_ak_callback_types_8h_source.html#l00077)

[AkMusicPlaylistCallbackInfo](struct_ak_music_playlist_callback_info.html)

**Definition:** [AkCallbackTypes.h:249](_ak_callback_types_8h_source.html#l00248)

[AkMusicPlaylistCallbackInfo::playlistID](struct_ak_music_playlist_callback_info_a4015338108567c652d091d526a694775.html#a4015338108567c652d091d526a694775)

AkUniqueID playlistID

ID of playlist node

**Definition:** [AkCallbackTypes.h:250](_ak_callback_types_8h_source.html#l00250)

[AkCallbackType](_ak_callback_types_8h_a948c083ff18dc4c8dfe1d32cb0eb6732.html#a948c083ff18dc4c8dfe1d32cb0eb6732)

AkCallbackType

Type of callback. Used as a bitfield in methods AK::SoundEngine::PostEvent() and AK::SoundEngine::Dyn...

**Definition:** [AkCallbackTypes.h:61](_ak_callback_types_8h_source.html#l00060)

[AK\_MusicPlaylistSelect](_ak_callback_types_8h_a948c083ff18dc4c8dfe1d32cb0eb6732.html#a948c083ff18dc4c8dfe1d32cb0eb6732aec46a37d9cfdef25777042feaf56e265)

@ AK\_MusicPlaylistSelect

Callback triggered when music playlist container must select the next item to play....

**Definition:** [AkCallbackTypes.h:71](_ak_callback_types_8h_source.html#l00071)

[AkUInt32](_ak_numeral_types_8h_a39c6c5d577901802ca77775760b704ce.html#a39c6c5d577901802ca77775760b704ce)

uint32\_t AkUInt32

Unsigned 32-bit integer

**Definition:** [AkNumeralTypes.h:35](_ak_numeral_types_8h_source.html#l00035)

[AkMusicPlaylistCallbackInfo::uNumPlaylistItems](struct_ak_music_playlist_callback_info_adef75376a27daf80e948ecc7d2c20eb8.html#adef75376a27daf80e948ecc7d2c20eb8)

AkUInt32 uNumPlaylistItems

Number of items in playlist node (may be segments or other playlists)

**Definition:** [AkCallbackTypes.h:251](_ak_callback_types_8h_source.html#l00251)

[AK::SoundEngine::PostEvent](namespace_a_k_1_1_sound_engine_a41e9ef8d42951871fe4a8ae58a29a68e.html#a41e9ef8d42951871fe4a8ae58a29a68e)

AKSOUNDENGINE\_API AkPlayingID PostEvent(AkUniqueID in\_eventID, AkGameObjectID in\_gameObjectID, AkUInt32 in\_uFlags=0, AkCallbackFunc in\_pfnCallback=NULL, void \*in\_pCookie=NULL, AkUInt32 in\_cExternals=0, AkExternalSourceInfo \*in\_pExternalSources=NULL, AkPlayingID in\_PlayingID=AK\_INVALID\_PLAYING\_ID)

[AkMusicSyncCallbackInfo](struct_ak_music_sync_callback_info.html)

**Definition:** [AkCallbackTypes.h:264](_ak_callback_types_8h_source.html#l00263)

[AK\_MusicSyncGrid](_ak_callback_types_8h_a948c083ff18dc4c8dfe1d32cb0eb6732.html#a948c083ff18dc4c8dfe1d32cb0eb6732a474f5b9582617f8a4f744e7d47dfa155)

@ AK\_MusicSyncGrid

Enable notifications on Music Grid. Callback info can be cast to AkMusicSyncCallbackInfo.

**Definition:** [AkCallbackTypes.h:78](_ak_callback_types_8h_source.html#l00078)

[AkPlayingID](_ak_typedefs_8h_a9270609771369ea575443fe080bbe9c3.html#a9270609771369ea575443fe080bbe9c3)

AkUInt32 AkPlayingID

A unique identifier generated whenever a PostEvent is called (or when a Dynamic Sequence is created)....

**Definition:** [AkTypedefs.h:34](_ak_typedefs_8h_source.html#l00034)