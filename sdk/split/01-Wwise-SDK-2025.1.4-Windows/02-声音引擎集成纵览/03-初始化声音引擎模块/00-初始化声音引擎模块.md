# 初始化声音引擎模块

|  |
| --- |
| Wwise SDK 2025.1.4 - Windows |

初始化声音引擎模块

集成 Wwise 声音引擎的第一步是在游戏启动时正确初始化构成声音引擎的各种模块。

在本示例工程中，定义了以下函数来执行与声音引擎初始化相关的一切操作：

bool InitSoundEngine()

{

... 在此执行初始化...

return true;

}

在主函数的开头调用它。让我们查看一下需要初始化的各项：

# 初始化 Memory Manager

第一个您必须初始化的组件是 Memory Manager（内存管理器）。您可以使用以下代码来创建默认的 Memory Manager：

#include <[AK/SoundEngine/Common/AkMemoryMgr.h](_ak_memory_mgr_8h.html)> // Memory Manager interface

#include <[AK/SoundEngine/Common/AkMemoryMgrModule.h](_ak_memory_mgr_module_8h.html)> // Default memory manager

(...)

bool InitSoundEngine()

{

[AkMemSettings](struct_ak_mem_settings.html) memSettings;

[AK::MemoryMgr::GetDefaultSettings](namespace_a_k_1_1_memory_mgr_ada3c244e4c16e6863cec97eef039319b.html#ada3c244e4c16e6863cec97eef039319b)(memSettings);

if ( [AK::MemoryMgr::Init](namespace_a_k_1_1_memory_mgr_a570a4ed4f667c187d21a821d846f4567.html#a570a4ed4f667c187d21a821d846f4567)( &memSettings ) != [AK\_Success](_ak_enums_8h_a64f7d1f79613cc4dcc49a4efba6caa63.html#a64f7d1f79613cc4dcc49a4efba6caa63ad7c47fea3da641e7422573c6a13dc35e) )

{

assert( !"Could not create the memory manager." );

return false;

}

(...)

}

|  |  |
| --- | --- |
|  | **备注:** 您可以覆盖 Memory Manager，在这种情况下，必须根据需要修改上述代码。请参阅 [取代内存管理器](memorymanager.html#overridememorymanager) 了解更多信息。 |

请参阅 [Memory Manager](memorymanager.html) 了解有关 Memory Manager 的更多详情。

# 初始化 Streaming Manager

Memory Manager 一旦初始化，我们就可以继续初始化 Streaming Manager 了。

以下代码对默认 Streaming Manager 进行初始化。它需要 `AK::StreamMgr::IAkFileLocationResolver` 实例，并会创建流播放设备。这需要 `AK::StreamMgr::IAkLowLevelIOHook` 实例。此接口在 [AkStreamMgrModule.h](_ak_stream_mgr_module_8h.html) 中定义。其中包含所有特定于 SDK 中默认 Stream Manager 实现的定义。

对于磁盘 I/O，集成声音引擎的推荐方式是使用默认 Stream Manager 实现，并实现 [AkStreamMgrModule.h](_ak_stream_mgr_module_8h.html) 中定义的接口。这些接口构成了 Low-Level I/O 子模块。请参阅 [流播放/流管理器](streamingdevicemanager.html) 了解更多信息。

本例中按原样使用了 CAkFilePackageLowLevelIODeferred 示例。此类用于实现 [AK::StreamMgr::IAkFileLocationResolver](class_a_k_1_1_stream_mgr_1_1_i_ak_file_location_resolver.html) 和 [AK::StreamMgr::IAkLowLevelIOHook](class_a_k_1_1_stream_mgr_1_1_i_ak_low_level_i_o_hook.html) 接口，并能加载通过 File Packager 实用程序生成的文件包（如需详细了解 File Packager 及其在 Low-Level I/O 中的运作方式，请参阅 [文件包底层 I/O 实现](samplecode.html#samplecode_integration_filepackagelowlevelio) 和 [File Packager 实用程序](samplecode.html#samplecode_integration_filepackager) 章节）。

请参阅 [Low-Level I/O](streamingmanager_lowlevel.html) 了解有关 Low-Level I/O 的更多信息。

#include <[AK/SoundEngine/Common/IAkStreamMgr.h](_i_ak_stream_mgr_8h.html)> // Streaming Manager

#include <[AK/Tools/Common/AkPlatformFuncs.h](_common_2_ak_platform_funcs_8h.html)> // 线程定义

#include <AkFilePackageLowLevelIODeferred.h> // Low-Level I/O 实现示例

(...)

// 我们使用作为 SDK 代码示例一部分的

// 默认 Low-Level I/O 实现。文件包扩展名为

CAkFilePackageLowLevelIODeferred g\_lowLevelIO;

(...)

bool InitSoundEngine()

{

(...)

//

// Create and initialize an instance of the default streaming manager. 注意，

// 可以使用您自己的流管理器覆盖默认流管理器。

//

[AkStreamMgrSettings](struct_ak_stream_mgr_settings.html) stmSettings;

[AK::StreamMgr::GetDefaultSettings](namespace_a_k_1_1_stream_mgr_a50fe8111fcb883651390fab6e9dc5ebc.html#a50fe8111fcb883651390fab6e9dc5ebc)( stmSettings );

// Customize the Stream Manager settings here.

if ( ![AK::StreamMgr::Create](../../../images/namespace_a_k_1_1_stream_mgr_af9d67dd0e502e5603a2921099916e2ab.html#af9d67dd0e502e5603a2921099916e2ab)( stmSettings ) )

{

assert( !"Could not create the Streaming Manager" );

return false;

}

//

// Create a streaming device.

// 注意，可以使用您自己的 Low-Level I/O 模块覆盖默认的 Low-Level I/O 模块。

//

[AkDeviceSettings](struct_ak_device_settings.html) deviceSettings;

[AK::StreamMgr::GetDefaultDeviceSettings](namespace_a_k_1_1_stream_mgr_a7d01e09a9bb6b6d34c2bb8f4c8995214.html#a7d01e09a9bb6b6d34c2bb8f4c8995214)( deviceSettings );

// Customize the streaming device settings here.

// CAkFilePackageLowLevelIODeferred::Init() 在 Stream Manager 中

// 创建流播放设备，并将其自身注册为 File Location Resolver。

if ( g\_lowLevelIO.Init( deviceSettings ) != [AK\_Success](_ak_enums_8h_a64f7d1f79613cc4dcc49a4efba6caa63.html#a64f7d1f79613cc4dcc49a4efba6caa63ad7c47fea3da641e7422573c6a13dc35e) )

{

assert( !"Could not create the streaming device and Low-Level I/O system" );

return false;

}

(...)

}

有关默认 Stream Manager 和流播放设备初始化设置的更多信息，请参阅 [Audiokinetic Stream Manager 初始化设置](streamingmanager_settings.html) 。

|  |  |
| --- | --- |
|  | **注意:** 某些初始化设置使用针对特定平台的成员结构，例如 AkThreadProperties。 |

如果您决定覆盖默认的 Low-Level I/O 实现或者整个 Streaming Manager，需要相应地修改此代码。请参阅 [流播放/流管理器](streamingdevicemanager.html) 了解更多信息。

# 初始化声音引擎

现在基本模块已经初始化，下面我们可以对声音引擎本身进行初始化了：

#include <[AK/SoundEngine/Common/AkSoundEngine.h](_ak_sound_engine_8h.html)> // 声音引擎

(...)

bool InitSoundEngine()

{

(...)

//

// Create the Sound Engine

// Using default initialization parameters

//

[AkInitSettings](struct_ak_init_settings.html) initSettings;

[AkPlatformInitSettings](struct_ak_platform_init_settings.html) platformInitSettings;

[AK::SoundEngine::GetDefaultInitSettings](namespace_a_k_1_1_sound_engine_a03381fc17e1b0ee16c2ab501c647ab9e.html#a03381fc17e1b0ee16c2ab501c647ab9e)( initSettings );

[AK::SoundEngine::GetDefaultPlatformInitSettings](namespace_a_k_1_1_sound_engine_aecdb9cd8f2d7f461ef1a58f5f5f5725d.html#aecdb9cd8f2d7f461ef1a58f5f5f5725d)( platformInitSettings );

if ( [AK::SoundEngine::Init](namespace_a_k_1_1_sound_engine_a9a26da64092b97243844df77cbcdbf5f.html#a9a26da64092b97243844df77cbcdbf5f)( &initSettings, &platformInitSettings ) != [AK\_Success](_ak_enums_8h_a64f7d1f79613cc4dcc49a4efba6caa63.html#a64f7d1f79613cc4dcc49a4efba6caa63ad7c47fea3da641e7422573c6a13dc35e) )

{

assert( !"Could not initialize the Sound Engine." );

return false;

}

(...)

}

有关如何初始化声音引擎的更多信息，请参阅 [高级声音引擎集成](soundengine_integration_init_advanced.html)

# 初始化 Spatial Audio

若您的工程使用 Wwise Spatial Audio，则在声音引擎之后还须初始化 Spatial Audio 库。有关如何使用 Spatial Audio 的基本信息，请参阅 [API 设置](spatial_audio.html#spatial_audio_api) 章节。如需了解可用于配置 Spatial Audio 的各项参数，请参阅 [AkSpatialAudioInitSettings](struct_ak_spatial_audio_init_settings.html) 章节。

|  |  |
| --- | --- |
|  | **备注:** 若要使用 Spatial Audio，必须链接 Spatial Audio 模块。 |

#include <[AK/SpatialAudio/Common/AkSpatialAudio.h](_ak_spatial_audio_8h.html)> // Spatial Audio

(...)

bool InitSoundEngine()

{

(...)

//

// 初始化 Spatial Audio

// 使用默认的初始化参数

//

[AkSpatialAudioInitSettings](struct_ak_spatial_audio_init_settings.html) settings; // 构造函数将建议的默认设置赋予 AkSpatialAudioInitSettings。

if ( [AK::SpatialAudio::Init](namespace_a_k_1_1_spatial_audio_a389709f9aaee2b3bdfbbe5cb352522ee.html#a389709f9aaee2b3bdfbbe5cb352522ee)( &settings ) != [AK\_Success](_ak_enums_8h_a64f7d1f79613cc4dcc49a4efba6caa63.html#a64f7d1f79613cc4dcc49a4efba6caa63ad7c47fea3da641e7422573c6a13dc35e) )

{

assert( !"Could not initialize the Spatial Audio." );

return false;

}

(...)

}

# 通信初始化

If you want to use Wwise Authoring to connect to your game and perform in-game mixing, profiling, and troubleshooting, you must initialize communications. We recommend that you do so because in-game mixing, profiling, and troubleshooting are powerful ways for sound designers to work on your game's audio efficiently.

To use communications, you need to link to the `CommunicationCentral` module.

To use `CommunicationCentral` on Windows, you must also link to the external Winsock 2 library (`ws2_32.lib`).

Communications are only available in the Debug and Profile sound engine configurations. They are not needed in the retail version of your game, so they are not part of the sound engine Release build. The following code uses the `AK_OPTIMIZED` symbol to omit communication-specific code from the release build.

// 为允许 Wwise 和游戏之间进行通信，包含以下代码——发布版本不需要

#ifndef AK\_OPTIMIZED

#include <[AK/Comm/AkCommunication.h](_ak_communication_8h.html)>

#endif // AK\_OPTIMIZED

(...)

bool InitSoundEngine()

{

(...)

#ifndef AK\_OPTIMIZED

//

// 对通信进行初始化（在发布版本中无此步骤！）

//

[AkCommSettings](struct_ak_comm_settings.html) commSettings;

[AK::Comm::GetDefaultInitSettings](namespace_a_k_1_1_comm_a3280f8b7ad6261d8b2a4bdf39c234fa7.html#a3280f8b7ad6261d8b2a4bdf39c234fa7)( commSettings );

if ( [AK::Comm::Init](namespace_a_k_1_1_comm_a596691b552b507c26b4df958ee1c6de8.html#a596691b552b507c26b4df958ee1c6de8)( commSettings ) != [AK\_Success](_ak_enums_8h_a64f7d1f79613cc4dcc49a4efba6caa63.html#a64f7d1f79613cc4dcc49a4efba6caa63ad7c47fea3da641e7422573c6a13dc35e) )

{

assert( !"Could not initialize communication." );

return false;

}

#endif // AK\_OPTIMIZED

(...)

}

现在您已将声音引擎的所有模块初始化。然后应注册插件（请参阅 [插件示例](quickstart_sample_integration_plugins.html#soundengine_integration_effects) ）。请参阅 [创建重复调用来执行音频处理](workingwithsdks_framerendering.html) 详细了解您在游戏循环中用于处理音频的、必须执行的调用。

## 控制台相关通信库

有些控制台通信库不能正确地平衡初始化/终止调用；因此，调用 [AK::Comm::Term](namespace_a_k_1_1_comm_a94e307d2974b89cc4fbc8ab0fef20d2f.html#a94e307d2974b89cc4fbc8ab0fef20d2f) 将终止控制台的底层通信库。这将关闭游戏的所有 TCP/IP 通信。如果您的游戏需要在终止后使通信库保持启用状态，AkCommSettings（结合 Ak::Comm:Init 使用）具有可供选择是否将系统库初始化的参数。如果您选择自己将通信库初始化，则请参照 Wwise 声音引擎的以下代码。游戏中应执行类似的代码。

Windows 套接字初始化：

WSAData wsaData = { 0 };

::WSAStartup( MAKEWORD( 2, 2 ), &wsaData )

终止：

::WSACleanup();

## 通信端口

[AkCommSettings](struct_ak_comm_settings.html) 结构的 [AkCommSettings::ports](struct_ak_comm_settings_a270a524ba5f6bad393b4de9b64a3981c.html#a270a524ba5f6bad393b4de9b64a3981c) 成员代表 Wwise 创作应用程序与声音引擎之间进行通信所使用的网络端口。当 Wwise 通信功能启用时，所有这些端口在游戏中都会打开。

### 一个固定端口：Discovery Broadcast

其中 [AkCommSettings::Ports::uDiscoveryBroadcast](struct_ak_comm_settings_1_1_ports_ac18f3080b45b5eba2634527d5d27e75c.html#ac18f3080b45b5eba2634527d5d27e75c) 端口不是动态的（不能设置为 0）。Wwise 创作应用程序需知道该端口才能在网络上发现游戏。另外，此处的指定值必须是创作应用程序 Project Settings 的 Network 选项卡中指定的值。

|  |  |
| --- | --- |
|  | **技巧:** 如果您的团队正在使用 Wwise 制作多款游戏，可以为每款游戏使用不同的 Discovery Broadcast 端口。通过这种方法，在 Wwise 创作应用程序中打开 Remote Connections 窗口时，只有对应当前 Wwise 工程的游戏才会被列出。更改此端口时，请确保在创作应用程序的 Project Settings 中*和*游戏中传递给 [AK::Comm::Init()](namespace_a_k_1_1_comm_a596691b552b507c26b4df958ee1c6de8.html#a596691b552b507c26b4df958ee1c6de8) 的 [AkCommSettings](struct_ak_comm_settings.html) 结构中一起更改。 |

### 一个动态端口

结构中的另一端口可以是动态的（或临时的）。这意味着，操作系统使用的不是固定端口，而是自动选择一个端口：

- [AkCommSettings::Ports::uCommand](struct_ak_comm_settings_1_1_ports_a2980cfef40f976dd403f8f48c0789265.html#a2980cfef40f976dd403f8f48c0789265)

此端口在默认情况下是动态的。建议将其保留为动态端口以尽量降低与其他应用程序发生冲突的机率。

若其与游戏的其他组件所用的端口发生冲突，请在调用 [AK::Comm::Init()](namespace_a_k_1_1_comm_a596691b552b507c26b4df958ee1c6de8.html#a596691b552b507c26b4df958ee1c6de8) 前在 [AkCommSettings](struct_ak_comm_settings.html) 结构中加以更改。

|  |  |
| --- | --- |
|  | **备注:** 在多平台游戏中，可在不同平台上对 [AkCommSettings::Ports::uCommand](struct_ak_comm_settings_1_1_ports_a2980cfef40f976dd403f8f48c0789265.html#a2980cfef40f976dd403f8f48c0789265) 使用不同的端口。 |

|  |  |
| --- | --- |
|  | **技巧:** 有关动态/临时端口的详细信息，请参阅以下文章：   - [Service Name and Transport Protocol Port Number Registry](http://www.iana.org/assignments/port-numbers) - [Ephemeral port](http://en.wikipedia.org/wiki/Ephemeral_port) - [The default dynamic port range for TCP/IP has changed since Windows Vista and in Windows Server 2008](https://support.microsoft.com/en-us/help/929851/the-default-dynamic-port-range-for-tcp-ip-has-changed-in-windows-vista) |

### 另一个端口（仅限于创作应用程序）

Wwise 通信中还涉及另一个端口，但它只在创作应用程序中打开，因此不是 [AkCommSettings::Ports](struct_ak_comm_settings_1_1_ports.html) 结构的一部分。

创作应用程序使用该端口来接收针对 Discovery Broadcast 消息的响应，这些消息用于检测网络上运行的游戏。它在默认情况下是动态的（设置为 0），但可以在创作应用程序的 Project Settings 中进行更改。

[AkCommunication.h](_ak_communication_8h.html)

[AkSoundEngine.h](_ak_sound_engine_8h.html)

[AK::SoundEngine::Init](namespace_a_k_1_1_sound_engine_a9a26da64092b97243844df77cbcdbf5f.html#a9a26da64092b97243844df77cbcdbf5f)

AKSOUNDENGINE\_API AKRESULT Init(AkInitSettings \*in\_pSettings, AkPlatformInitSettings \*in\_pPlatformSettings)

[AkMemoryMgrModule.h](_ak_memory_mgr_module_8h.html)

[AK::SpatialAudio::Init](namespace_a_k_1_1_spatial_audio_a389709f9aaee2b3bdfbbe5cb352522ee.html#a389709f9aaee2b3bdfbbe5cb352522ee)

AKSOUNDENGINE\_API AKRESULT Init(const AkSpatialAudioInitSettings &in\_initSettings)

Initialize the SpatialAudio API.

[AK::MemoryMgr::Init](namespace_a_k_1_1_memory_mgr_a570a4ed4f667c187d21a821d846f4567.html#a570a4ed4f667c187d21a821d846f4567)

AKSOUNDENGINE\_API AKRESULT Init(AkMemSettings \*in\_pSettings)

[AkPlatformInitSettings](struct_ak_platform_init_settings.html)

**Definition:** [AkWinSoundEngine.h:43](_ak_win_sound_engine_8h_source.html#l00042)

[AK::StreamMgr::GetDefaultSettings](namespace_a_k_1_1_stream_mgr_a50fe8111fcb883651390fab6e9dc5ebc.html#a50fe8111fcb883651390fab6e9dc5ebc)

AKSOUNDENGINE\_API void GetDefaultSettings(AkStreamMgrSettings &out\_settings)

[AK::Comm::Init](namespace_a_k_1_1_comm_a596691b552b507c26b4df958ee1c6de8.html#a596691b552b507c26b4df958ee1c6de8)

AKSOUNDENGINE\_API AKRESULT Init(const AkCommSettings &in\_settings)

[AkDeviceSettings](struct_ak_device_settings.html)

**Definition:** [AkStreamMgrModule.h:59](_ak_stream_mgr_module_8h_source.html#l00058)

[AK::SoundEngine::GetDefaultInitSettings](namespace_a_k_1_1_sound_engine_a03381fc17e1b0ee16c2ab501c647ab9e.html#a03381fc17e1b0ee16c2ab501c647ab9e)

AKSOUNDENGINE\_API void GetDefaultInitSettings(AkInitSettings &out\_settings)

[IAkStreamMgr.h](_i_ak_stream_mgr_8h.html)

[AkMemSettings](struct_ak_mem_settings.html)

**Definition:** [AkMemoryMgrModule.h:149](_ak_memory_mgr_module_8h_source.html#l00148)

[AK::MemoryMgr::GetDefaultSettings](namespace_a_k_1_1_memory_mgr_ada3c244e4c16e6863cec97eef039319b.html#ada3c244e4c16e6863cec97eef039319b)

AKSOUNDENGINE\_API void GetDefaultSettings(AkMemSettings &out\_pMemSettings)

Obtain the default initialization settings for the default implementation of the Memory Manager.

[AK::Comm::GetDefaultInitSettings](namespace_a_k_1_1_comm_a3280f8b7ad6261d8b2a4bdf39c234fa7.html#a3280f8b7ad6261d8b2a4bdf39c234fa7)

AKSOUNDENGINE\_API void GetDefaultInitSettings(AkCommSettings &out\_settings)

[AkSpatialAudioInitSettings](struct_ak_spatial_audio_init_settings.html)

Initialization settings of the spatial audio module.

**Definition:** [AkSpatialAudioTypes.h:220](_ak_spatial_audio_types_8h_source.html#l00219)

[AkMemoryMgr.h](_ak_memory_mgr_8h.html)

[AkPlatformFuncs.h](_common_2_ak_platform_funcs_8h.html)

[AK::SoundEngine::GetDefaultPlatformInitSettings](namespace_a_k_1_1_sound_engine_aecdb9cd8f2d7f461ef1a58f5f5f5725d.html#aecdb9cd8f2d7f461ef1a58f5f5f5725d)

AKSOUNDENGINE\_API void GetDefaultPlatformInitSettings(AkPlatformInitSettings &out\_platformSettings)

[AK::StreamMgr::Create](namespace_a_k_1_1_stream_mgr_af9d67dd0e502e5603a2921099916e2ab.html#af9d67dd0e502e5603a2921099916e2ab)

AKSOUNDENGINE\_API IAkStreamMgr \* Create(const AkStreamMgrSettings &in\_settings)

[AK::StreamMgr::GetDefaultDeviceSettings](namespace_a_k_1_1_stream_mgr_a7d01e09a9bb6b6d34c2bb8f4c8995214.html#a7d01e09a9bb6b6d34c2bb8f4c8995214)

AKSOUNDENGINE\_API void GetDefaultDeviceSettings(AkDeviceSettings &out\_settings)

[AkInitSettings](struct_ak_init_settings.html)

**Definition:** [AkSoundEngine.h:193](_ak_sound_engine_8h_source.html#l00192)

[AK\_Success](_ak_enums_8h_a64f7d1f79613cc4dcc49a4efba6caa63.html#a64f7d1f79613cc4dcc49a4efba6caa63ad7c47fea3da641e7422573c6a13dc35e)

@ AK\_Success

The operation was successful.

**Definition:** [AkEnums.h:34](_ak_enums_8h_source.html#l00034)

[AkStreamMgrSettings](struct_ak_stream_mgr_settings.html)

**Definition:** [AkStreamMgrModule.h:50](_ak_stream_mgr_module_8h_source.html#l00049)

[AkSpatialAudio.h](_ak_spatial_audio_8h.html)

[AkCommSettings](struct_ak_comm_settings.html)

**Definition:** [AkCommunication.h:47](_ak_communication_8h_source.html#l00046)