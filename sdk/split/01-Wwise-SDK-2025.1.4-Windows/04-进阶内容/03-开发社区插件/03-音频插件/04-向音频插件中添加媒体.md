# 向音频插件中添加媒体

|  |
| --- |
| Wwise SDK 2025.1.4 - Windows |

向音频插件中添加媒体

插件媒体系统使插件（效果器、源插件、Sink 插件或混音器）可利用 Wwise 架构存储工程中的二进制数据文件。

以下是在插件中使用插件媒体相对于使用自定义数据的诸多优势：

- 内置的数据持久化
- 集成了版本控制（使用工作组功能）
- 允许单独为每个平台实施数据转码
- 允许终端用户选择用来存放数据的 SoundBank

# Wwise Authoring 插件

## 管理插件媒体

您可以通过在后端获取 `AK::Wwise::Plugin::RequestObjectMedia` 来请求 Object Media 服务。 藉此，可提供成员 `m_objectMedia` 以访问相应的服务方法。若要接收有关对象媒体的通知（比如在用户执行更改后），请从 `AK::Wwise::Plugin::Notifications::ObjectMedia` 获取，并覆盖 `AK::Wwise::Plugin::Notifications::ObjectMedia::NotifyPluginMediaChanged()` 方法。

class MyPluginBackend

: public [AK::Wwise::Plugin::AudioPlugin](class_a_k_1_1_wwise_1_1_plugin_1_1_v1_1_1_audio_plugin.html)

, public [AK::Wwise::Plugin::RequestObjectMedia](class_a_k_1_1_wwise_1_1_plugin_1_1_requested_host_interface_3_01_object_media_01_4.html)

, public [AK::Wwise::Plugin::Notifications::ObjectMedia](class_a_k_1_1_wwise_1_1_plugin_1_1_v1_1_1_notifications_1_1_object_media__.html)

, public [AK::Wwise::Plugin::RequestHost](class_a_k_1_1_wwise_1_1_plugin_1_1_requested_host_interface_3_01_host_01_4.html)

{

void [NotifyPluginMediaChanged](class_a_k_1_1_wwise_1_1_plugin_1_1_v1_1_1_notifications_1_1_object_media___aeeade48f5038593806cbe55ee2204135.html#aeeade48f5038593806cbe55ee2204135)() override

{

// React to change

// ...

// Notify Wwise the data needs to be reconverted

m\_host.NotifyInternalDataChanged(

[AK::IAkPluginParam::ALL\_PLUGIN\_DATA\_ID](class_a_k_1_1_i_ak_plugin_param_a7d4422a73ca832f64edc0465e59be771.html#a7d4422a73ca832f64edc0465e59be771),

true /\* in\_bMakeProjectDirty \*/

);

}

};

您可以通过调用 `AK::Wwise::Plugin::ObjectMedia::SetMediaSource()` 来导入媒体文件。 在导入媒体时，其将被复制到插件的 Originals 目录下，并完全由 Wwise 进行管理。 在索引 0 处添加插件媒体文件：

m\_pObjMedia->SetMediaSource( pszFilename, 0, bReplace );

覆盖函数 `NotifyPluginMediaChanged` 以在插件数据发生更改时接收通知。只要对媒体源进行修改就会触发 `NotifyPluginMediaChanged` 函数。

void NotifyPluginMediaChanged() override

{

// React to changes

// ...

// 通知 Wwise 需要重新转码数据

m\_pPSet->NotifyInternalDataChanged( [AK::IAkPluginParam::ALL\_PLUGIN\_DATA\_ID](class_a_k_1_1_i_ak_plugin_param_a7d4422a73ca832f64edc0465e59be771.html#a7d4422a73ca832f64edc0465e59be771) );

}

请参阅 `AK::Wwise::Plugin::ObjectMedia` 的功能文档了解详情。

## 为运行时组件转码媒体

若插件定义文件使用 `CanReferenceDataFile`，则须在运行时将导入的原始 WAV 媒体转码为适合实时组件的格式。

要想实现媒体转码，需从 `AK::Wwise::Plugin::MediaConverter` 继承并实现所需函数：

- `AK::Wwise::Plugin::MediaConverter::ConvertFile`
- `AK::Wwise::Plugin::MediaConverter::GetCurrentConversionSettingsHash`

class MyPlugin

: public [AK::Wwise::Plugin::AudioPlugin](class_a_k_1_1_wwise_1_1_plugin_1_1_v1_1_1_audio_plugin.html),

, public [AK::Wwise::Plugin::MediaConverter](class_a_k_1_1_wwise_1_1_plugin_1_1_v1_1_1_media_converter.html)

以下是 `AK::Wwise::Plugin::MediaConverter` 函数的应用示例：

#include <[AK/Tools/Common/AkFNVHash.h](_ak_f_n_v_hash_8h.html)>

#include <filesystem>

#include <ctype.h>

[AK::Wwise::Plugin::ConversionResult](namespace_a_k_1_1_wwise_1_1_plugin_a63998463d5dba5bfb0df9321dbe3e5c3.html#a63998463d5dba5bfb0df9321dbe3e5c3) MyPlugin::ConvertFile(

const GUID& in\_guidPlatform,

const [BasePlatformID](struct_base_platform_i_d.html)& in\_basePlatform,

const [AkOSChar](_platforms_2_windows_2_ak_types_8h_af48843ed095e0ea7dd05bd1b64070664.html#af48843ed095e0ea7dd05bd1b64070664)\* in\_szSourceFile,

const [AkOSChar](_platforms_2_windows_2_ak_types_8h_af48843ed095e0ea7dd05bd1b64070664.html#af48843ed095e0ea7dd05bd1b64070664)\* in\_szDestFile,

[AkUInt32](_ak_numeral_types_8h_a39c6c5d577901802ca77775760b704ce.html#a39c6c5d577901802ca77775760b704ce) in\_uSampleRate,

[AkUInt32](_ak_numeral_types_8h_a39c6c5d577901802ca77775760b704ce.html#a39c6c5d577901802ca77775760b704ce) in\_uBlockLength,

IProgress\* in\_pProgress,

IWriteString\* io\_pError)

{

// 将原始源文件转码为经过转码的文件。

// 至少将原始文件复制到已转码的文件中

std::error\_code ec;

std::filesystem::copy(

in\_szSourceFile,

in\_szDestFile,

std::filesystem::copy\_options::overwrite\_existing,

ec

);

if (ec)

{

return [AK](namespace_a_k.html):[Wwise::Plugin::ConversionFailed](namespace_a_k_1_1_wwise_1_1_plugin_a63998463d5dba5bfb0df9321dbe3e5c3.html#a63998463d5dba5bfb0df9321dbe3e5c3a067c828fdfd88765697e4914fa192efc);

}

return [AK::Wwise::Plugin::ConversionSuccess](namespace_a_k_1_1_wwise_1_1_plugin_a63998463d5dba5bfb0df9321dbe3e5c3.html#a63998463d5dba5bfb0df9321dbe3e5c3a292220d538f5f5381f6f0514c782059f);

}

uint32\_t MyPlugin::GetCurrentConversionSettingsHash(

const GUID& in\_guidPlatform,

[AkUInt32](_ak_numeral_types_8h_a39c6c5d577901802ca77775760b704ce.html#a39c6c5d577901802ca77775760b704ce) in\_uSampleRate,

[AkUInt32](_ak_numeral_types_8h_a39c6c5d577901802ca77775760b704ce.html#a39c6c5d577901802ca77775760b704ce) in\_uBlockLength)

{

[AK::FNVHash32](class_a_k_1_1_f_n_v_hash.html) hashFunc;

// 使用影响转码的参数生成哈希值。

// 提取源文件名称。

char szInputFileName[\_MAX\_PATH];

auto size = m\_pObjMedia->GetMediaSourceFileName(szInputFileName, \_MAX\_PATH);

if (size == 0)

return 0;

for (int i = 0; i < size; ++i)

{

szInputFileName[i] = tolower(szInputFileName[i]);

}

return hashFunc.[Compute](class_a_k_1_1_f_n_v_hash_a907841bf37541824958d382686b1fb1f.html#a907841bf37541824958d382686b1fb1f)(szInputFileName, size);

}

## 插件定义

在插件定义文件（即插件 XML 文件）中，确保将 `CanReferenceDataFile` 元素设为 `true`。

<PluginModule>

<EffectPlugin Name="YOUR\_PLUGIN" CompanyID="???" PluginID="???">

<[PluginInfo](namespace_a_k_1_1_wwise_1_1_plugin_a69141ebf4159597c1e76aad07862c823.html#a69141ebf4159597c1e76aad07862c823) MenuPath="???">

<PlatformSupport>

<Platform Name="Windows">

...

<CanReferenceDataFile>true</CanReferenceDataFile>

</Platform>

<Platform Name="XboxOne">

...

<CanReferenceDataFile>true</CanReferenceDataFile>

</Platform>

# 运行时插件

## 在运行时使用插件媒体

在插件的声音引擎部分中实现 `AK::IAkEffectPlugin` 时，会在 `Init(...)` 函数中接收 `AK::IAkEffectPluginContext` 指针。从 `AK::IAkEffectPluginContext` 中，您可以调用 `AK::IAkPluginContextBase::GetPluginMedia` 来获取经过转码的媒体，这些媒体打包存储于 Wwise 的 SoundBank 中。

[AKRESULT](_ak_enums_8h_a64f7d1f79613cc4dcc49a4efba6caa63.html#a64f7d1f79613cc4dcc49a4efba6caa63) [RunTimeEffect::Init](namespace_a_k_1_1_comm_a596691b552b507c26b4df958ee1c6de8.html#a596691b552b507c26b4df958ee1c6de8)(

[AK::IAkPluginMemAlloc](class_a_k_1_1_i_ak_plugin_mem_alloc.html)\* in\_pAllocator, // 内存分配器接口。

[AK::IAkEffectPluginContext](class_a_k_1_1_i_ak_effect_plugin_context.html)\* in\_pFXCtx, // FX 环境。

const [AkAudioFormat](struct_ak_audio_format.html)& in\_rFormat // 音频输入格式。)

{

[AkUInt8](_ak_numeral_types_8h_a6a754f6e0ddd97ae59f3aae854cde270.html#a6a754f6e0ddd97ae59f3aae854cde270) \* pPluginData = NULL;

[AkUInt32](_ak_numeral_types_8h_a39c6c5d577901802ca77775760b704ce.html#a39c6c5d577901802ca77775760b704ce) uPluginDataSize;

in\_pFXCtx->[GetPluginMedia](class_a_k_1_1_i_ak_plugin_context_base_a36514f7827919ee6c85a56295141297a.html#a36514f7827919ee6c85a56295141297a)( 0, pPluginData, uPluginDataSize );

if ( pPluginData == NULL )

return [AK\_Fail](_ak_enums_8h_a64f7d1f79613cc4dcc49a4efba6caa63.html#a64f7d1f79613cc4dcc49a4efba6caa63a904c9822fd2d40bb0ea6bfad9ead659b); // 没有冲激响应的时候无需实例化插件。

...

}

|  |  |
| --- | --- |
|  | **备注:** 本例展示了如何在运行时使用 **effect** 插件媒体。不过，其也可用来阐释如何使用另一插件类型，如 **source** 插件。在这种情况下，要实现 `AK::IAkSourcePlugin` 并接收 `AK::IAkSourcePluginContext` 指针。 |

# 在 Wwise 中的用法

## 在总线效果器中使用插件媒体

在 Wwise 中所有总线效果器存储在 Init.bnk 中。为了尽量减小 Init.bnk 的大小，系统不会将插件媒体自动添加到 Init.bnk。您必须手动将 Effect ShareSet 或总线添加到单独的 SoundBank。

[AK](namespace_a_k.html)

Definition of data structures for AkAudioObject

**Definition:** [AkWwiseSDKVersion.cs:31](_ak_wwise_s_d_k_version_8cs_source.html#l00030)

[AkFNVHash.h](_ak_f_n_v_hash_8h.html)

[AK.Wwise::Plugin::V1::Notifications::ObjectMedia\_](class_a_k_1_1_wwise_1_1_plugin_1_1_v1_1_1_notifications_1_1_object_media__.html)

**Definition:** [HostObjectMedia.h:521](_host_object_media_8h_source.html#l00520)

[AK.Wwise::Plugin::ConversionSuccess](namespace_a_k_1_1_wwise_1_1_plugin_a63998463d5dba5bfb0df9321dbe3e5c3.html#a63998463d5dba5bfb0df9321dbe3e5c3a292220d538f5f5381f6f0514c782059f)

@ ConversionSuccess

**Definition:** [PluginDef.h:149](_plugin_def_8h_source.html#l00149)

[AK::FNVHash](class_a_k_1_1_f_n_v_hash.html)

**Definition:** [AkFNVHash.h:74](_ak_f_n_v_hash_8h_source.html#l00073)

[AkUInt8](_ak_numeral_types_8h_a6a754f6e0ddd97ae59f3aae854cde270.html#a6a754f6e0ddd97ae59f3aae854cde270)

uint8\_t AkUInt8

Unsigned 8-bit integer

**Definition:** [AkNumeralTypes.h:34](_ak_numeral_types_8h_source.html#l00034)

[AK::IAkPluginContextBase::GetPluginMedia](class_a_k_1_1_i_ak_plugin_context_base_a36514f7827919ee6c85a56295141297a.html#a36514f7827919ee6c85a56295141297a)

virtual void GetPluginMedia(AkUInt32 in\_dataIndex, AkUInt8 \*&out\_rpData, AkUInt32 &out\_rDataSize)=0

[AK::Comm::Init](namespace_a_k_1_1_comm_a596691b552b507c26b4df958ee1c6de8.html#a596691b552b507c26b4df958ee1c6de8)

AKSOUNDENGINE\_API AKRESULT Init(const AkCommSettings &in\_settings)

[BasePlatformID](struct_base_platform_i_d.html)

**Definition:** [PlatformID.h:41](_platform_i_d_8h_source.html#l00040)

[AK.Wwise::Plugin::PluginInfo](namespace_a_k_1_1_wwise_1_1_plugin_a69141ebf4159597c1e76aad07862c823.html#a69141ebf4159597c1e76aad07862c823)

CPluginInfo PluginInfo

**Definition:** [PluginInstanceTypes.h:537](_plugin_instance_types_8h_source.html#l00537)

[AK::IAkPluginMemAlloc](class_a_k_1_1_i_ak_plugin_mem_alloc.html)

**Definition:** [IAkPluginMemAlloc.h:42](_i_ak_plugin_mem_alloc_8h_source.html#l00041)

[AK.Wwise::Plugin::V1::MediaConverter](class_a_k_1_1_wwise_1_1_plugin_1_1_v1_1_1_media_converter.html)

**Definition:** [MediaConverter.h:125](_media_converter_8h_source.html#l00124)

[AK.Wwise::Plugin::V1::AudioPlugin](class_a_k_1_1_wwise_1_1_plugin_1_1_v1_1_1_audio_plugin.html)

Wwise API for general Audio Plug-in's backend.

**Definition:** [AudioPlugin.h:133](_audio_plugin_8h_source.html#l00130)

[AK.Wwise::Plugin::ConversionResult](namespace_a_k_1_1_wwise_1_1_plugin_a63998463d5dba5bfb0df9321dbe3e5c3.html#a63998463d5dba5bfb0df9321dbe3e5c3)

ConversionResult

Conversion error code.

**Definition:** [PluginDef.h:148](_plugin_def_8h_source.html#l00147)

[AK\_Fail](_ak_enums_8h_a64f7d1f79613cc4dcc49a4efba6caa63.html#a64f7d1f79613cc4dcc49a4efba6caa63a904c9822fd2d40bb0ea6bfad9ead659b)

@ AK\_Fail

The operation failed.

**Definition:** [AkEnums.h:35](_ak_enums_8h_source.html#l00035)

[AK.Wwise::Plugin::V1::Notifications::ObjectMedia\_::NotifyPluginMediaChanged](class_a_k_1_1_wwise_1_1_plugin_1_1_v1_1_1_notifications_1_1_object_media___aeeade48f5038593806cbe55ee2204135.html#aeeade48f5038593806cbe55ee2204135)

virtual void NotifyPluginMediaChanged()

This function is called by Wwise when any of the plug-in media changes.

**Definition:** [HostObjectMedia.h:591](_host_object_media_8h_source.html#l00591)

[AkOSChar](_platforms_2_windows_2_ak_types_8h_af48843ed095e0ea7dd05bd1b64070664.html#af48843ed095e0ea7dd05bd1b64070664)

wchar\_t AkOSChar

Generic character string

**Definition:** [AkTypes.h:122](_platforms_2_windows_2_ak_types_8h_source.html#l00122)

[AKRESULT](_ak_enums_8h_a64f7d1f79613cc4dcc49a4efba6caa63.html#a64f7d1f79613cc4dcc49a4efba6caa63)

AKRESULT

**Definition:** [AkEnums.h:32](_ak_enums_8h_source.html#l00031)

[AK.Wwise::Plugin::RequestedHostInterface< ObjectMedia >](class_a_k_1_1_wwise_1_1_plugin_1_1_requested_host_interface_3_01_object_media_01_4.html)

**Definition:** [HostObjectMedia.h:622](_host_object_media_8h_source.html#l00622)

[AK.Wwise::Plugin::RequestedHostInterface< Host >](class_a_k_1_1_wwise_1_1_plugin_1_1_requested_host_interface_3_01_host_01_4.html)

**Definition:** [Host.h:164](_host_8h_source.html#l00164)

[AK.Wwise::Plugin::ConversionFailed](namespace_a_k_1_1_wwise_1_1_plugin_a63998463d5dba5bfb0df9321dbe3e5c3.html#a63998463d5dba5bfb0df9321dbe3e5c3a067c828fdfd88765697e4914fa192efc)

@ ConversionFailed

**Definition:** [PluginDef.h:151](_plugin_def_8h_source.html#l00151)

[AkUInt32](_ak_numeral_types_8h_a39c6c5d577901802ca77775760b704ce.html#a39c6c5d577901802ca77775760b704ce)

uint32\_t AkUInt32

Unsigned 32-bit integer

**Definition:** [AkNumeralTypes.h:35](_ak_numeral_types_8h_source.html#l00035)

[AK::FNVHash::Compute](class_a_k_1_1_f_n_v_hash_a907841bf37541824958d382686b1fb1f.html#a907841bf37541824958d382686b1fb1f)

HashParams::HashType Compute(const void \*in\_pData, typename HashParams::SizeType in\_dataSize)

**Definition:** [AkFNVHash.h:105](_ak_f_n_v_hash_8h_source.html#l00105)

[AK::IAkPluginParam::ALL\_PLUGIN\_DATA\_ID](class_a_k_1_1_i_ak_plugin_param_a7d4422a73ca832f64edc0465e59be771.html#a7d4422a73ca832f64edc0465e59be771)

static const AkPluginParamID ALL\_PLUGIN\_DATA\_ID

**Definition:** [IAkPlugin.h:773](_i_ak_plugin_8h_source.html#l00773)

[AkAudioFormat](struct_ak_audio_format.html)

Defines the parameters of an audio buffer format.

**Definition:** [AkCommonDefs.h:61](_ak_common_defs_8h_source.html#l00060)

[AK::IAkEffectPluginContext](class_a_k_1_1_i_ak_effect_plugin_context.html)

**Definition:** [IAkPlugin.h:370](_i_ak_plugin_8h_source.html#l00369)